<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<link rel="stylesheet" href="/css/postform.css">

<div class="post-form-container" id="Post-Form">
    <div class="post-form">
        <div class="post-form-header">
            <h2 class="post-form-title">Create post</h2>
            <button class="close-button" onclick="closePostForm()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="post-form-body">
            <div class="user-info">
                <img src="<%= user && user.img ? user.img : '/images/clone.png' %>" alt="User Avatar" class="user-avatar">
                <div class="user-details">
                    <span class="user-name"><%= user ? user.username : 'User' %></span>
                </div>
            </div>
            <textarea class="post-textarea post-textarea-title" placeholder="<%= user ? user.username : null%>, What's your title today?" ></textarea>
            <textarea class="post-textarea post-textarea-text" placeholder="<%= user ? user.username : null %>, What do you want to share?"></textarea>
            <div class="post-options">
                <div class="additional-options">
                    <div class="option" onclick="handleShowFileInput()">
                        <i class="fas fa-image"></i>
                    </div>
                    <div class="option" onclick="showUrlInput()">
                        <span>URL</span>
                    </div>
                </div>
            </div>
            <div class="url-input-container" id="urlInputContainer" style="display: none;">
                <input type="text" id="imageUrl" placeholder="Or paste an image URL" oninput="handlePostImageChangeWithUrl(event)">
                <button class="url-close-button" onclick="hideUrlInput()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="post-form-footer">
            <button class="post-submit-button" onclick="handlePost()" disabled>Post</button>
        </div>
    </div>
</div>

<input type="file" id="postImageFile" accept="image/*" style="display: none;" onchange="handlePostImageChange(event)">


<input type="file" id="postImageFile" accept="image/*" style="display: none;" onchange="handlePostImageChange(event)">


<script>

    function closePostForm() {
    const postForm = document.getElementById('Post-Form');
    postForm.style.display = 'none';
}

document.addEventListener('DOMContentLoaded', () => {
    const textareas = document.querySelectorAll('.post-textarea');
    const submitButton = document.querySelector('.post-submit-button');
    textareas.forEach(textarea => {
        textarea.addEventListener('input', () => {
            // Check if all the textareas have content
            const allHaveContent = Array.from(textareas).every(ta => ta.value.trim().length > 0);
            submitButton.disabled = !allHaveContent;
        });
    });
});

function handleShowFileInput() {
    const fileInput = document.getElementById('postImageFile');
    fileInput.click();  
}

function showUrlInput() {
    document.getElementById('imageUrl').style.display = 'block';
    document.getElementById('postImageFile').style.display = 'none';
}

let postImageFile = null;
let imageUrl = '';

function handlePostImageChange(event) {
    postImageFile = event.target.files[0];  // Set the selected file
    imageUrl = '';  // Clear the URL

    // Clear the URL input field
    document.getElementById('imageUrl').value = ''; 
}

function handlePostImageChangeWithUrl(event) {
    imageUrl = event.target.value.trim();
    postImageFile = null;  // Clear the file input when a new URL is entered
    
    
    document.getElementById('postImageFile').value = ''; // Clear the file input field
}

const handlePost = async () => {
    const title = document.querySelector('.post-textarea-title').value.trim();
    const text = document.querySelector('.post-textarea-text').value.trim();
    const userId = '<%= user ? user._id : null %>';

    let imageData = '';

    try {
        // Check if there's an image file
        if (postImageFile) {
            const formData = new FormData();
            formData.append('imageFile', postImageFile);

            // Upload the image file to the server
            const uploadResponse = await axios.post('/post-img', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data',
                },
                withCredentials: true
            });

            // Use the uploaded file path from the server's response
            imageData = uploadResponse.data.fileUrl;
            console.log(imageData)
        } else if (imageUrl) {
            // If an image URL is provided, use it directly
            imageData = imageUrl;
        }

        const postData = {
            title,
            text,
            user: { _id: userId },
            img: imageData,
        };
        const response = await axios.post('https://group-project-cosc3060-cosc3061-2024b-g2-ylkb.onrender.com/api/posts', postData, {
            withCredentials: true
        });

        if (response.status === 200) {
            alert('Post created successfully!');
            closePostForm(); 
            window.location.reload();
        } else {    
            alert('Failed to create post. Please try again.');
        }
    } catch (error) {
        console.error('Error creating post:', error);

        if (error.response && error.response.status === 403) {
            alert('Your account got locked. Please mail to my business email to ask for activating your account.');
            handleLogout(); 
        } else {
            alert('Failed to create post. Please try again.');
        }
    }
};
const handleEdit = async (postId, postImg, imageUrl = '') => {

    const title = document.querySelector('.post-textarea-title').value.trim();
    const text = document.querySelector('.post-textarea-text').value.trim();
    const userId = '<%= user ? user._id : null %>';
    imageUrl = document.querySelector('#imageUrl').value.trim();
    let imageData = postImg; // Start with the current image

    try {
        // Prioritize the image URL if provided, otherwise check for file upload
        if (imageUrl) {
            imageData = imageUrl;

            if (postImg && postImg.startsWith('https://pub-93b162f2c2324969b45e28374787425b.r2.dev/')) {
                const formData = new FormData();
                formData.append('imageFile', ''); // Empty file data
                await axios.post(`/post-img?postImg=${postImg}`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data',
                    },
                    withCredentials: true,
                });
            }
        } else if (postImageFile) {
            // If there's no URL but a new image file, upload it
            const formData = new FormData();
            formData.append('imageFile', postImageFile);

            // Upload the new image file to the server
            const uploadResponse = await axios.post(`/post-img?postImg=${postImg}`, formData, {
                headers: {
                    'Content-Type': 'multipart/form-data',
                },
                withCredentials: true
            });

            if (uploadResponse.status === 200) {
                imageData = uploadResponse.data.fileUrl;
            } else {
                alert('Failed to upload the new image. Please try again.');
                return; // Stop execution if upload fails
            }
        }

        // Prepare the post data to update
        const postData = {
            title,
            text,
            user: { _id: userId },
            img: imageData,  // Use the updated image path
        };

        // Attempt to update the post data
        const response = await axios.put(`https://group-project-cosc3060-cosc3061-2024b-g2-ylkb.onrender.com/api/posts/${postId}`, postData, {
            withCredentials: true
        });

        // If the post update fails, notify the user
        if (response.status !== 200) {
            alert('Failed to update post. Please try again.');
            return; // Exit if the post update fails
        }

        alert('Post updated successfully!');
        closePostForm(); 
        window.location.reload();
    } catch (error) {
        console.error('Error updating post:', error);

        // Improved error handling
        if (error.response && error.response.status === 403) {
            alert('Your account got locked. Please mail to my business email to ask for activating your account.');
            handleLogout(); 
        } else {
            alert('Failed to update post. Please try again.');
        }
    }
};
function showUrlInput() {
    document.getElementById('urlInputContainer').style.display = 'flex';
    document.getElementById('postImageFile').style.display = 'none';
}

function hideUrlInput() {
    document.getElementById('urlInputContainer').style.display = 'none';
    document.getElementById('imageUrl').value = ''; // Clear the URL input field
    imageUrl = ''; // Clear the global imageUrl variable
}

</script>