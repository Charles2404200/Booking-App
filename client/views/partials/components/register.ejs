<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<link rel="stylesheet" href="/css/register.css">
<div class="register-modal" id="Register">
    <div class="register-overlay"></div>
    <div class="register-container">
        <button class="close-btn" onclick="closeRegister()">X</button>
        <h2>Register</h2>
        <form id="register-form">
            <div class="form-group">
                <label for="username">Username</label>
                <input
                    type="text"
                    id="username"
                    name="username"
                    required
                />
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    required
                />
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input
                    type="password"
                    id="password"
                    name="password"
                    required
                />
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input
                    type="password"
                    id="confirmPassword"
                    name="confirmPassword"
                    required
                />
            </div>
            <div id="error-message" class="error-message" style="display: none;"></div> 

            <button type="submit" id="register-button">Register</button>
            <div id="loading-message" class="loading-message" style="display: none;">Loading...</div> 
        </form>
    </div>
</div>

<script>
  
  function validatePassword(password) {
    const minLength = 8;
    const hasUpperCase = /[A-Z]/.test(password);
    const hasLowerCase = /[a-z]/.test(password);
    const hasNumbers = /\d/.test(password);
    const hasSpecialChars = /[!@#?$%^&*(),.?":{}|<>]/.test(password);
    const hasInvalidChars = /[<>]/.test(password);  

    if (password.length < minLength) {
      showErrorMessage('Password must be at least 8 characters long.');
      return false;
    }
    if (!hasUpperCase) {
      showErrorMessage('Password must include at least one uppercase letter.');
      return false;
    }
    if (!hasLowerCase) {
      showErrorMessage('Password must include at least one lowercase letter.');
      return false;
    }
    if (!hasNumbers) {
      showErrorMessage('Password must include at least one number.');
      return false;
    }
    if (!hasSpecialChars) {
      showErrorMessage('Password must include at least one special character.');
      return false;
    }
    if (hasInvalidChars) {
      showErrorMessage('Password must not include < or > characters.');
      return false;
    }

    return true;
}
    function showErrorMessage(message) {
    const errorMessage = document.getElementById('error-message');
    errorMessage.innerText = message;
    errorMessage.style.display = 'block';
  }
    async function handleRegister(event) {
        event.preventDefault();
        
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const errorMessageElement = document.getElementById('error-message');
        const loadingMessageElement = document.getElementById('loading-message');
        const registerButton = document.getElementById('register-button');

        errorMessageElement.style.display = 'none';
        loadingMessageElement.style.display = 'none';

        if (password !== confirmPassword) {
            errorMessageElement.innerText = "Password and Confirm Password do not match";
            errorMessageElement.style.display = 'block';
            return;
        }

        if (!validatePassword(password)) {
           
            return;
        }

        loadingMessageElement.style.display = 'block';
        registerButton.disabled = true;

        try {
            const response = await axios.post('https://group-project-cosc3060-cosc3061-2024b-g2-ylkb.onrender.com/api/auth/register', {
                username,
                email,
                password,
            }, { withCredentials: true });
            openLogin();
        } catch (error) {
            const errorMessage = error.response && error.response.data && error.response.data.errors
                ? error.response.data.errors.map(err => err.msg).join(", ")
                : "Failed to register user";

            errorMessageElement.innerText = errorMessage;
            errorMessageElement.style.display = 'block';
        } finally {
            loadingMessageElement.style.display = 'none';
            registerButton.disabled = false;
        }
    }

    document.getElementById('register-form').addEventListener('submit', handleRegister);
</script>