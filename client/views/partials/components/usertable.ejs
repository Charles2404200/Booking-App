<link rel="stylesheet" href="/css/usertable.css">
<div class="User-Table" style="display:block;">
    <div class="user-management-header">
        <button class="create-user-btn" onclick="openCreateAndEditUserForm()">Create User</button>
    </div>
<div class="data-grid">
   <table>
        <thead>
            <tr>
                <th>Username</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Email</th>
                <th>Date</th>
                <th>Country</th>
                <th>Image</th>
                <th>City</th>
                <th>Phone</th>
                <th>Status</th>
                <th>Created At</th>
                <th>Updated At</th>
                <th>Editing Account</th>
            </tr>
        </thead>
        <tbody id="table-body">
            <% rows.forEach((row, index) => { %>
                <tr id="user-row-<%= row.id %>">
                    <td><%= row.username %></td>
                    <td><%= row.fname %></td>
                    <td><%= row.lname %></td>
                    <td><%= row.email %></td>
                    <td><%= row.date ? new Date(row.date).toLocaleString() : 'N/A' %></td>
                    <td><%= row.country %></td>
                    <td><img src="<%= row.img  || '/images/clone.png'%>" alt="User Image" class="user-img"></td>
                    <td><%= row.city %></td>
                    <td><%= row.phone %></td>
                    <td>
                        <select onchange="handleStatusChange('<%= row.id %>', this.value)">
                            <option value="active" <%= row.status === 'active' ? 'selected' : ''%>>Active</option>
                            <option value="disabled" <%= row.status === 'disabled' ? 'selected' : '' %>>Disabled</option>
                            <option value="lock" <%= row.status === 'lock' ? 'selected' : '' %>>Lock</option>
                        </select>
                    </td>
                    <td><%= new Date(row.createdAt).toLocaleString() %></td>
                    <td><%= new Date(row.updatedAt).toLocaleString() %></td>
                    <td>
                        <div class="user-action-buttons">
                            <button class="edit-btn" onclick="openCreateAndEditUserForm('<%= row.id %>')">Edit</button>
                            <button class="delete-btn" onclick="handleDeleteUser('<%= row.id %>')">Delete</button>
                        </div>
                    </td>
                </tr>
            <% }) %>
        </tbody>
    </table>
</div>
<div class="pagination" id="user-pagination">
    <button id="prevUserPage" class="disabled" onclick="changeUserPage(-1)">Previous</button>
    <button id="nextUserPage" onclick="changeUserPage(1)">Next</button>
</div>
</div>



<script>


    async function handleStatusChange(id, newStatus) {
        try {
            await axios.put(`https://group-project-cosc3060-cosc3061-2024b-g2-ylkb.onrender.com/api/users/${id}`, { status: newStatus }, { withCredentials: true });
            // Optionally, update the UI to reflect the status change without a page refresh
        } catch (err) {
            console.error('Error updating user status:', err);
        }
    }
    function openCreateAndEditUserForm(userId = null) {
    const createUserForm = document.getElementById('create-user-form');
    // Reset form fields
    document.getElementById('create-user-id').value = '';
    document.getElementById('create-user-username').value = '';
    document.getElementById('create-user-fname').value = '';
    document.getElementById('create-user-lname').value = '';
    document.getElementById('create-user-email').value = '';
    document.getElementById('create-user-password').value = '';
    document.getElementById('create-user-confirm-password').value = '';
    document.getElementById('create-user-role').value = 'user';
    document.getElementById('create-user-date').value = '';
    document.getElementById('create-user-country').value = '';
    document.getElementById('create-user-city').value = '';
    document.getElementById('create-user-phone').value = '';
    document.getElementById('create-user-status').value = 'disabled';

    if (userId) {
        // Fetch user data from the backend and populate the form
        axios.get(`https://group-project-cosc3060-cosc3061-2024b-g2-ylkb.onrender.com/api/users/${userId}`, { withCredentials: true })
            .then(response => {
                const user = response.data;

                document.getElementById('create-user-id').value = user._id;
                document.getElementById('create-user-username').value = user.username;
                document.getElementById('create-user-fname').value = user.fname;
                document.getElementById('create-user-lname').value = user.lname;
                document.getElementById('create-user-email').value = user.email;
                document.getElementById('create-user-role').value = user.isAdmin ? 'admin' : 'user';
                document.getElementById('create-user-date').value = user.date ? new Date(user.date).toISOString().split('T')[0] : '';
                document.getElementById('create-user-country').value = user.country;
                document.getElementById('create-user-city').value = user.city;
                document.getElementById('create-user-phone').value = user.phone;
                document.getElementById('create-user-status').value = user.status;
            })
            .catch(error => {
                console.error('Error fetching user data:', error);
            });

    }

    createUserForm.style.display = 'block';
}

async function handleDeleteUser(userId, userImg) {
    if (confirm("Are you sure you want to delete this user? This action cannot be undone.")) {
        try {
            const response = await axios.delete(`https://group-project-cosc3060-cosc3061-2024b-g2-ylkb.onrender.com/api/users/${userId}`, {
                withCredentials: true,
            });

            if (response.status === 200) {
                // Post update to delete the user's image
                if (userImg && userImg.startsWith('https://pub-93b162f2c2324969b45e28374787425b.r2.dev/')) {
                    const formData = new FormData();
                    formData.append('imageFile', '');

                    await axios.post(`/update-img?userImg=${userImg}`, formData, {
                        headers: {
                            'Content-Type': 'multipart/form-data',
                        },
                        withCredentials: true,
                    });
                }
                
                // Remove the row from the table
                const row = document.getElementById(`user-row-${userId}`);
                if (row) {
                    row.remove();
                }
                // Re-render the table to adjust pagination if necessary
                renderTable();
                alert("User deleted successfully!");
            } else {
                alert("Failed to delete user. Please try again.");
            }
        } catch (error) {
            console.error("Error deleting user:", error);
            alert("Failed to delete user. Please try again.");
        }
    }
}
</script>